# 🎯 Как это работает - Визуальная схема

## 📊 Полный цикл работы бота

```
┌─────────────────────────────────────────────────────────────────┐
│                    TELEGRAM USER                                │
│                         👤                                       │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            │ Отправляет текст:
                            │ "telescope"
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                    TELEGRAM BOT                                 │
│                    (badge_bot.py)                               │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ Step 1: Получение сообщения                              │  │
│  │ • Парсинг текста пользователя                            │  │
│  │ • Валидация входных данных                               │  │
│  │ • Сохранение в контекст                                  │  │
│  └──────────────────────────────────────────────────────────┘  │
│                            │                                     │
│                            ▼                                     │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ Step 2: Формирование промпта                             │  │
│  │ • Добавление trigger word                                │  │
│  │ • Объединение с базовым промптом                         │  │
│  │ • Добавление стилевых параметров                         │  │
│  └──────────────────────────────────────────────────────────┘  │
│                            │                                     │
│                            ▼                                     │
│  Промпт: "aidbox_samurai_style, samurai warrior badge,          │
│           character holding telescope, cartoon illustration..."  │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            │ API Request
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                    REPLICATE API                                │
│                    (replicate.com)                              │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ LoRA Model Processing                                    │  │
│  │                                                          │  │
│  │  1. Загрузка вашей LoRA модели                          │  │
│  │     ↓                                                    │  │
│  │  2. Применение weights к базовой модели                 │  │
│  │     ↓                                                    │  │
│  │  3. Генерация изображения (30 steps)                    │  │
│  │     ↓                                                    │  │
│  │  4. Post-processing                                     │  │
│  │     ↓                                                    │  │
│  │  5. Загрузка на CDN                                     │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  Время: ~10-30 секунд                                           │
│  Стоимость: ~$0.005-0.01                                        │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            │ Возвращает URL изображения
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                    TELEGRAM BOT                                 │
│                    (badge_bot.py)                               │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ Step 3: Post-processing                                  │  │
│  │                                                          │  │
│  │  1. Загрузка изображения по URL                         │  │
│  │     ↓                                                    │  │
│  │  2. Открытие с помощью PIL                              │  │
│  │     ↓                                                    │  │
│  │  3. Добавление баннера (золотой прямоугольник)          │  │
│  │     ↓                                                    │  │
│  │  4. Рендеринг текста (указанный пользователем)          │  │
│  │     ↓                                                    │  │
│  │  5. Сохранение в BytesIO                                │  │
│  └──────────────────────────────────────────────────────────┘  │
│                            │                                     │
│                            ▼                                     │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ Step 4: Отправка пользователю                            │  │
│  │ • Формирование caption                                   │  │
│  │ • Отправка через Telegram API                            │  │
│  │ • Логирование успешной генерации                         │  │
│  └──────────────────────────────────────────────────────────┘  │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            │ Отправляет готовый бейдж
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                    TELEGRAM USER                                │
│                         👤                                       │
│                    Получает бейдж! 🎉                           │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔄 Диалоговый процесс

```
┌────────────────┐
│   User         │
│   /start       │
└───────┬────────┘
        │
        ▼
┌────────────────────────────────────────┐
│ Bot: "Что держит персонаж?"            │
└───────┬────────────────────────────────┘
        │
        ▼
┌────────────────┐
│   User         │
│   "telescope"  │
└───────┬────────┘
        │
        ▼
┌────────────────────────────────────────┐
│ Bot: "Какой текст на баннере?"         │
└───────┬────────────────────────────────┘
        │
        ▼
┌────────────────┐
│   User         │
│ "UX SCOUT"     │
└───────┬────────┘
        │
        ▼
┌────────────────────────────────────────┐
│ Bot: "⏳ Генерирую... (1/2)"          │
└───────┬────────────────────────────────┘
        │
        ▼ [Replicate API Call]
        │
        ▼
┌────────────────────────────────────────┐
│ Bot: "⏳ Добавляю текст... (2/2)"     │
└───────┬────────────────────────────────┘
        │
        ▼ [PIL Processing]
        │
        ▼
┌────────────────────────────────────────┐
│ Bot: [PHOTO]                           │
│      "🎊 Твой бейдж готов!"           │
│      "/create для ещё одного"          │
└────────────────────────────────────────┘
```

---

## 🎨 Процесс обучения LoRA

```
┌─────────────────────────────────────────────────────────────┐
│ ШАГ 1: Подготовка данных                                    │
│                                                             │
│  training_images/                                           │
│  ├── samurai_with_sword.png     ◄─── 15-25 изображений    │
│  ├── samurai_with_scroll.png                               │
│  ├── samurai_with_lamp.png                                 │
│  └── ...                                                    │
│                                                             │
│  Требования:                                                │
│  • Одинаковый стиль персонажа                              │
│  • Разные объекты                                           │
│  • 1024x1024 px                                             │
│  • Чистый фон                                               │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ ШАГ 2: Создание архива                                      │
│                                                             │
│  python train_lora.py                                       │
│  └─► Опция 2: Создать архив                                │
│       └─► training_data.zip (создан)                       │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ ШАГ 3: Загрузка на хостинг                                  │
│                                                             │
│  Google Drive / Dropbox / GitHub Release                    │
│  └─► Получаем прямую ссылку для скачивания                │
│       https://example.com/training_data.zip                 │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ ШАГ 4: Запуск обучения                                      │
│                                                             │
│  Replicate Training API                                     │
│  • Model: flux-dev-lora-trainer                             │
│  • Input: training_data.zip URL                             │
│  • Trigger: "aidbox_samurai_style"                          │
│  • Steps: 1000                                              │
│  • Learning rate: 0.0004                                    │
│                                                             │
│  Время: 30-60 минут ⏱                                      │
│  Стоимость: $2-5 💰                                         │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ ШАГ 5: Проверка результата                                  │
│                                                             │
│  python test_lora.py                                        │
│  └─► Тестируем с разными промптами                         │
│       └─► Проверяем качество в test_results/              │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│ ШАГ 6: Интеграция в бота                                    │
│                                                             │
│  badge_bot.py:                                              │
│  LORA_MODEL = "username/samurai-badge-lora"                 │
│                                                             │
│  python badge_bot.py ✅                                     │
└─────────────────────────────────────────────────────────────┘
```

---

## 💾 Архитектура данных

```
┌─────────────────────────────────────────────────────────────┐
│                    USER CONTEXT                             │
│                  (In-Memory Storage)                        │
│                                                             │
│  user_id: 123456789                                         │
│  ├── object: "telescope"                                    │
│  ├── badge_text: "UX SCOUT"                                 │
│  ├── timestamp: 2025-11-11 10:30:00                         │
│  └── state: WAITING_FOR_BADGE_TEXT                          │
└─────────────────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                   IMAGE GENERATION                          │
│                                                             │
│  Input:                                                     │
│  └─► Prompt: "aidbox_samurai_style, holding telescope"     │
│                                                             │
│  Processing:                                                │
│  └─► Replicate API → LoRA Model → Generated Image          │
│                                                             │
│  Output:                                                    │
│  └─► URL: https://replicate.delivery/pbxt/xyz123.png      │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                   TEXT OVERLAY                              │
│                   (PIL Processing)                          │
│                                                             │
│  1. Download image from URL                                 │
│  2. Load into PIL.Image                                     │
│  3. Create ImageDraw object                                 │
│  4. Draw golden banner rectangle                            │
│  5. Render text "UX SCOUT"                                  │
│  6. Add stroke/outline                                      │
│  7. Save to BytesIO                                         │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                  TELEGRAM DELIVERY                          │
│                                                             │
│  await update.message.reply_photo(                          │
│      photo=final_image,                                     │
│      caption="🎊 Твой бейдж готов!"                        │
│  )                                                          │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔐 Безопасность и обработка ошибок

```
┌─────────────────────────────────────────────────────────────┐
│                   ERROR HANDLING                            │
│                                                             │
│  TRY:                                                       │
│  ├── Generate image                                         │
│  ├── Add text                                               │
│  └── Send to user                                           │
│                                                             │
│  EXCEPT Exception as e:                                     │
│  ├── Log error to file                                      │
│  ├── Send friendly message to user                          │
│  ├── Clear user context                                     │
│  └── Suggest retry                                          │
│                                                             │
│  FINALLY:                                                   │
│  └── Clean up temporary files                               │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                   RATE LIMITING                             │
│                   (Replicate Side)                          │
│                                                             │
│  Free Tier:                                                 │
│  • 100 requests/month                                       │
│  • Throttled at 10 requests/minute                          │
│                                                             │
│  Paid Tier:                                                 │
│  • Unlimited requests                                       │
│  • Pay per generation                                       │
│  • No throttling                                            │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                   LOGGING                                   │
│                                                             │
│  Level: INFO                                                │
│  Format: [timestamp] [user_id] [action] [result]            │
│                                                             │
│  Examples:                                                  │
│  • 2025-11-11 10:30:00 - User 123: Generating image        │
│  • 2025-11-11 10:30:15 - User 123: Image generated         │
│  • 2025-11-11 10:30:20 - User 123: Badge completed         │
│  • 2025-11-11 10:30:25 - User 123: Sent to user            │
└─────────────────────────────────────────────────────────────┘
```

---

## 📈 Производительность

```
┌─────────────────────────────────────────────────────────────┐
│                   TIMING BREAKDOWN                          │
│                                                             │
│  User sends message                                         │
│  ↓ (instant)                                                │
│  Bot receives & validates                                   │
│  ↓ (<100ms)                                                 │
│  API request to Replicate                                   │
│  ↓ (200-500ms network)                                      │
│  LoRA model loading                                         │
│  ↓ (2-5 seconds)                                            │
│  Image generation (30 steps)                                │
│  ↓ (5-20 seconds)                                           │
│  Post-processing                                            │
│  ↓ (1-2 seconds)                                            │
│  Upload to CDN                                              │
│  ↓ (500ms-2s)                                               │
│  Download to bot                                            │
│  ↓ (500ms-2s)                                               │
│  PIL text overlay                                           │
│  ↓ (500ms-1s)                                               │
│  Send to user                                               │
│  ↓ (200-500ms)                                              │
│  User receives badge                                        │
│                                                             │
│  TOTAL: ~10-30 seconds                                      │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                   OPTIMIZATION TIPS                         │
│                                                             │
│  1. Reduce inference steps: 30 → 20                         │
│     Saves: ~3-5 seconds                                     │
│                                                             │
│  2. Use faster model: Flux-Schnell                          │
│     Saves: ~5-10 seconds                                    │
│                                                             │
│  3. Cache common generations                                │
│     Saves: Entire generation time                           │
│                                                             │
│  4. Use webhooks instead of polling                         │
│     Saves: Latency overhead                                 │
│                                                             │
│  5. Parallel processing for multiple users                  │
│     Improves: Throughput                                    │
└─────────────────────────────────────────────────────────────┘
```

---

## 🎯 Итоговая схема успеха

```
           ┌──────────────────────┐
           │   Подготовка         │
           │   • 15-25 изображений│
           │   • API токены       │
           └──────────┬───────────┘
                      │
                      ▼
           ┌──────────────────────┐
           │   Обучение LoRA      │
           │   • 30-60 минут      │
           │   • $2-5             │
           └──────────┬───────────┘
                      │
                      ▼
           ┌──────────────────────┐
           │   Тестирование       │
           │   • Проверка качества│
           │   • Настройка        │
           └──────────┬───────────┘
                      │
                      ▼
           ┌──────────────────────┐
           │   Запуск бота        │
           │   • python badge_bot │
           └──────────┬───────────┘
                      │
                      ▼
           ┌──────────────────────┐
           │   Работа!            │
           │   • Автогенерация    │
           │   • Ваш стиль        │
           │   • Масштабируемость │
           └──────────────────────┘

                      ✨
                   SUCCESS!
```
